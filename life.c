#include "app.h"


//#define GET_PIXCEL(buf,x,y)		(buf[(y)*(160/8)+((x)/8)] & (0x01<<((x)%8)))
//#define SET_PIXCEL(buf,x,y)		(buf[(y)*(160/8)+((x)/8)] |= (0x01<<((x)%8)))
//#define CLR_PIXCEL(buf,x,y)		(buf[(y)*(160/8)+((x)/8)] &= ~(0x01<<((x)%8)))

#define GET_PIXCEL(buf,x,y)		(buf[(y)*(160/8)+((x)>>3)] & (0x01<<((x)&7)))
#define SET_PIXCEL(buf,x,y)		(buf[(y)*(160/8)+((x)>>3)] |= (0x01<<((x)&7)))
#define CLR_PIXCEL(buf,x,y)		(buf[(y)*(160/8)+((x)>>3)] &= ~(0x01<<((x)&7)))


static const char pat1[3][3]={					// グライダー
	{1,1,1},
	{1,0,0},
	{0,1,0},
};
static const char pat2[5][7]={					// 重量級宇宙船
	{0,0,0,1,1,0,0},
	{0,1,0,0,0,0,1},
	{1,0,0,0,0,0,0},
	{1,0,0,0,0,0,1},
	{1,1,1,1,1,1,0},
};
static const char pat3[11][38]={				// グライダー銃
	{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0},
	{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0},
	{0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0},
	{0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0},
	{0,1,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{0,1,1,0,0,0,0,0,0,0,0,1,0,0,0,1,0,1,1,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0},
	{0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0},
	{0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
};
static const char pat4[18][5]={				// 汽車ポッポ１
	{0,0,0,1,0},
	{0,0,0,0,1},
	{1,0,0,0,1},
	{0,1,1,1,1},
	{0,0,0,0,0},
	{0,0,0,0,0},
	{0,0,0,0,0},
	{1,0,0,0,0},
	{0,1,1,0,0},
	{0,0,1,0,0},
	{0,0,1,0,0},
	{0,1,0,0,0},
	{0,0,0,0,0},
	{0,0,0,0,0},
	{0,0,0,1,0},
	{0,0,0,0,1},
	{1,0,0,0,1},
	{0,1,1,1,1},
};
static const char pat5[23][17]={				// 汽車ポッポ２
	{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0},
	{0,0,0,0,0,0,0,0,1,1,1,0,1,1,0,0,0},
	{0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0},
	{0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0},
	{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0},
	{0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0},
	{0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0},
	{0,1,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0},
	{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{0,1,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0},
	{0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0},
	{0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0},
	{0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0},
	{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
	{0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0},
	{0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0},
	{0,0,0,0,0,0,0,0,1,1,1,0,1,1,0,0,0},
	{0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0},
	{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
};
static const char pat6[8][10]={				// 繁殖型１
	{0,0,0,0,0,0,0,0,0,0},
	{0,0,0,0,0,0,0,1,0,0},
	{0,0,0,0,0,1,0,1,1,0},
	{0,0,0,0,0,1,0,1,0,0},
	{0,0,0,0,0,1,0,0,0,0},
	{0,0,0,1,0,0,0,0,0,0},
	{0,1,0,1,0,0,0,0,0,0},
	{0,0,0,0,0,0,0,0,0,0},
};
static const char pat7[17][14]={				// 汽車ポッポ３
	{0,1,1,1,1,0,0,0,0,0,0,0,0,0},
	{1,0,0,0,1,0,0,0,0,0,0,0,0,0},
	{0,0,0,0,1,0,0,0,0,0,0,0,0,0},
	{0,0,0,1,0,0,0,0,0,0,0,0,0,0},
	{0,0,0,0,0,0,0,0,0,0,1,1,1,1},
	{0,0,0,0,0,0,0,0,0,1,0,0,0,1},
	{0,0,0,0,0,0,0,0,0,0,0,0,0,1},
	{0,0,0,0,0,1,1,0,0,1,0,0,1,0},
	{0,0,0,0,0,1,1,1,0,0,0,0,0,0},
	{0,0,0,0,0,1,1,0,0,1,0,0,1,0},
	{0,0,0,0,0,0,0,0,0,0,0,0,0,1},
	{0,0,0,0,0,0,0,0,0,1,0,0,0,1},
	{0,0,0,0,0,0,0,0,0,0,1,1,1,1},
	{0,0,0,1,0,0,0,0,0,0,0,0,0,0},
	{0,0,0,0,1,0,0,0,0,0,0,0,0,0},
	{1,0,0,0,1,0,0,0,0,0,0,0,0,0},
	{0,1,1,1,1,0,0,0,0,0,0,0,0,0},
};

int work_buf[16000/sizeof(int)];
static char *buf1 = (char*)work_buf;
static char *buf2 = (char*)&work_buf[3000/sizeof(int)];


static void start_disp();
static void draw_ban(char *buf);
static void update(char *src, char *dst);
static void copy(char *buf, char *pat, int x, int y, int xpw, int ypw);
static void setting();


/********************************************************************************/
/*		main																	*/
/*		mult=3 : xw=106, yw=80													*/
/*		mult=4 : xw=80,  yw=60													*/
/********************************************************************************/
static const struct menu life_menu[]={
	{0,  0, 1, "重量級宇宙船"},
	{0, 15, 2, "グライダー銃"},
	{0, 30, 5, "繁殖型１"},
	{0, 45, 3, "汽車ポッポ１"},
	{0, 60, 4, "汽車ポッポ２"},
	{0, 75, 6, "汽車ポッポ３"},
	{0, 90,100, "< 設定 >"},
	{0,0,0,0},
};
void life_main()
{
	int cmd;
	
	for(;;){
		start_disp();
		memset(buf1, 0, 3000);
		memset(buf2, 0, 3000);
		lcd_clear(WHITE);

		cmd = menu_select(life_menu);

		switch(cmd){
			case 1:						// 重量級宇宙船
				copy(buf1, (char*)pat2, 140,60, 7,5);
				break;
			case 2:						// グライダー銃
				copy(buf1, (char*)pat3, 0,0, 38,11);
				break;
			case 3:						// 汽車ポッポ１
				copy(buf1, (char*)pat4, 20,65, 5,18);
				break;
			case 4:						// 汽車ポッポ２
				copy(buf1, (char*)pat5, 0,65, 17,23);
				break;
			case 5:						// 繁殖型１
				copy(buf1, (char*)pat6, 100,110, 10,8);
				break;
			case 6:						// 汽車ポッポ３
				copy(buf1, (char*)pat7, 10,65, 14,17);
				break;
			case 100:					// 設定
				setting();
				break;
		}
		lcd_clear(BLACK);
		for(;;){
			draw_ban(buf1);
			update(buf1, buf2);
			draw_ban(buf2);
			update(buf2, buf1);
			if(sw_sense()){
				break;
			}
		}
	}
}
/********************************************************************************/
/*		setting																	*/
/********************************************************************************/
static void setting()
{
	int x, y, xw, yw, sw;
	
	lcd_clear(WHITE);
	str_disp(0,5, "Up/Down/Right/Left: 移動");
	str_disp(0,20, "A-SW: set/reset");
	str_disp(0,30, "B-SW: end");
	sw_updown();
	x = 80;
	y = 75;
	xw = 160;
	yw = 150;
	for(;;){
		sw = sw_updown();
		draw_ban(buf1);
		if(sw & UP){
			if(--y < 1){
				y = 1;
			}
		}
		else if(sw & DOWN){
			if(++y >= yw-1){
				y = yw-2;
			}
		}
		else if(sw & RIGHT){
			if(++x >= xw-1){
				x = xw-2;
			}
		}
		else if(sw & LEFT){
			if(--x < 1){
				x = 1;
			}
		}
		else if(sw & A_SW){
			if(GET_PIXCEL(buf1,x,y)){		// セットされているからクリアする
				CLR_PIXCEL(buf1,x,y);
			}
			else{							// クリアされているからセットする
				SET_PIXCEL(buf1,x,y);
			}
			draw_ban(buf1);
			continue;
		}
		else if(sw & B_SW){
			return;
		}
		pset(x,y, GRAY);
	}
}
/********************************************************************************/
/*		copy																	*/
/*		画面の幅と高さは xw と yw だ											*/
/*		xpw/ypw: パターンデータの幅と高さ										*/
/*		x/y:  コピー先の座標													*/
/********************************************************************************/
static void copy(char *buf, char *pat, int x, int y, int xpw, int ypw)
{
	int xx, yy;
	
	for(yy=0; yy<ypw; yy++){
		for(xx=0; xx<xpw; xx++){
			if(pat[yy*xpw+xx]){
				SET_PIXCEL(buf,x+xx,y+yy);
			}
			else{
				CLR_PIXCEL(buf,x+xx,y+yy);
			}
		}
	}
}
/********************************************************************************/
/*		update																	*/
/********************************************************************************/
static void update(char *src, char *dst)
{
	int x, y, xw, yw, cnt;
	
	xw = 160;
	yw = 150;
	for(y=1; y<yw-1; y++){
		for(x=1; x<xw-1; x++){
			// 0 の数をカウント
			cnt = !GET_PIXCEL(src,x,y-1) + !GET_PIXCEL(src,x,y+1) + !GET_PIXCEL(src,x-1,y) + !GET_PIXCEL(src,x+1,y);
			cnt += !GET_PIXCEL(src,x-1,y-1) + !GET_PIXCEL(src,x+1,y-1) + !GET_PIXCEL(src,x-1,y+1) + !GET_PIXCEL(src,x+1,y+1);
			if(GET_PIXCEL(src, x, y)){		// 生きているセル
				if((8-cnt)!=2 && (8-cnt)!=3){
					CLR_PIXCEL(dst,x,y);
//					dst[y*(320/8)+(x/8)] &= ~(0x01<<(x%8));
				}
				else{
					SET_PIXCEL(dst,x,y);
//					dst[y*(320/8)+(x/8)] |= (0x01<<(x%8));
				}
			}
			else{
				if((8-cnt)==3){
					SET_PIXCEL(dst,x,y);
//					dst[y*(320/8)+(x/8)] |= (0x01<<(x%8));
				}
				else{
					CLR_PIXCEL(dst,x,y);
//					dst[y*(320/8)+(x/8)] &= ~(0x01<<(x%8));
				}
			}
		}
	}
}
/********************************************************************************/
/*		draw_ban																*/
/********************************************************************************/
static void draw_ban(char *buf)
{
	int x1, x2, bit, y, tmp, c;
	
	for(y=0; y<150; y++){
		for(x1=0; x1<(160/8); x1++){
			tmp = buf[x1];
			bit = 0x01;
			for(x2=0; x2<8; x2++){
				c = tmp&bit ? BLACK : WHITE;
				pset((x1<<3)+x2, y, c);
				bit <<= 1;
			}
		}
		buf += 160/8;
	}
}
/********************************************************************************/
/*		start_disp																*/
/********************************************************************************/
static void start_disp()
{
	lcd_clear(BRUE);
	text_color = WHITE;
	back_color = BRUE;
	//                     1   5    0    5    0    5
	str_disp(0,  0, "ライフゲームは");
	str_disp(0, 15, "セル・オートマトン");
	str_disp(0, 30, "と呼ばれるプログラムで");
	str_disp(0, 45, "初期配置から始まり");
	str_disp(0, 60, "代々のパターン変化を");
	str_disp(0, 75, "楽しむものです。");
	str_disp(0, 95, "K.Fukumoto");
	sw_updown();
}
